# AIèšåˆå·¥å…·

ä¸€ä¸ªå…¼å®¹OpenAI APIçš„AIæ¨¡å‹èšåˆä»£ç†ï¼Œæ”¯æŒå¤šä¸ªAIä¾›åº”å•†çš„ç»Ÿä¸€æ¥å£ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- âœ… å®Œå…¨å…¼å®¹OpenAI APIæ ¼å¼
- âœ… æ”¯æŒå¤šä¸ªAIä¾›åº”å•†ç»Ÿä¸€æ¥å…¥
- âœ… æµå¼å’Œéæµå¼å“åº”æ”¯æŒ
- âœ… æ¨¡å‹åç§°æ ¼å¼ï¼š`ä¾›åº”å•†/æ¨¡å‹`
- âœ… è‡ªåŠ¨è·å–ä¾›åº”å•†æ¨¡å‹åˆ—è¡¨
- âœ… é…ç½®æ–‡ä»¶çƒ­é‡è½½
- âœ… TokenéªŒè¯æœºåˆ¶
- âœ… å¥åº·æ£€æŸ¥å’Œç›‘æ§
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… å¼‚æ­¥è¯·æ±‚æ”¯æŒ
- âœ… å¯é…ç½®æ—¥å¿—çº§åˆ«
- âœ… è¿æ¥æ± ç®¡ç†
- âœ… å“åº”å¤§å°é™åˆ¶
- âœ… æ€§èƒ½ç›‘æ§

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®æœåŠ¡

å¤åˆ¶é…ç½®ç¤ºä¾‹æ–‡ä»¶ï¼š
```bash
cp config.json.example config.json
```

ç¼–è¾‘ `config.json`ï¼š
```json
{
  "host": "localhost",
  "port": 8001,
  "log_level": "WARNING",
  "providers": [
    "zhipu|https://open.bigmodel.cn/api/paas/v4|your-api-key",
    "openai|https://api.openai.com/v1|sk-your-key"
  ],
  "tokens": [
    "my-token|sk-test-123456"
  ],
  "supported_models": [
    ".*"
  ]
}
```

### 3. å¯åŠ¨æœåŠ¡

```bash
python api.py
```

æœåŠ¡å°†åœ¨é…ç½®çš„ç«¯å£å¯åŠ¨ï¼ˆé»˜è®¤8001ï¼‰ã€‚

## ğŸ“‹ é…ç½®è¯´æ˜

### config.json é…ç½®é¡¹

| é…ç½®é¡¹ | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `host` | string | å¦ | `localhost` | æœåŠ¡ç›‘å¬åœ°å€ |
| `port` | int | å¦ | `8080` | æœåŠ¡ç›‘å¬ç«¯å£ |
| `log_level` | string | å¦ | `WARNING` | æ—¥å¿—çº§åˆ«ï¼ˆDEBUG/INFO/WARNING/ERROR/CRITICALï¼‰ |
| `providers` | array | æ˜¯ | `[]` | ä¾›åº”å•†é…ç½®åˆ—è¡¨ |
| `tokens` | array | æ˜¯ | `[]` | API Tokenç™½åå• |
| `supported_models` | array | å¦ | `[]` | æ”¯æŒçš„æ¨¡å‹æ­£åˆ™è¡¨è¾¾å¼ |
| `max_connections` | int | å¦ | `100` | æœ€å¤§è¿æ¥æ•° |
| `max_keepalive_connections` | int | å¦ | `20` | æœ€å¤§ä¿æŒè¿æ¥æ•° |
| `keepalive_expiry` | float | å¦ | `30.0` | è¿æ¥è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ |
| `stream_timeout` | float | å¦ | `300.0` | æµå¼è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ |
| `non_stream_timeout` | float | å¦ | `30.0` | éæµå¼è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ |
| `max_response_size` | int | å¦ | `10485760` | æœ€å¤§å“åº”å¤§å°ï¼ˆå­—èŠ‚ï¼Œé»˜è®¤10MBï¼‰ |

### ä¾›åº”å•†é…ç½®æ ¼å¼

```
ä¾›åº”å•†åç§°|API_URL|API_KEY
```

ç¤ºä¾‹ï¼š
```json
"providers": [
  "zhipu|https://open.bigmodel.cn/api/paas/v4|your-zhipu-key",
  "openai|https://api.openai.com/v1|sk-your-openai-key",
  "anthropic|https://api.anthropic.com/v1|sk-ant-your-key"
]
```

### Tokené…ç½®æ ¼å¼

```
æè¿°|tokenå€¼
```

ç¤ºä¾‹ï¼š
```json
"tokens": [
  "admin|sk-admin-123456",
  "user1|sk-user1-789012"
]
```

### å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  "host": "localhost",
  "port": 8001,
  "log_level": "WARNING",
  
  "providers": [
    "zhipu|https://open.bigmodel.cn/api/paas/v4|your-api-key",
    "openai|https://api.openai.com/v1|sk-your-key"
  ],
  
  "tokens": [
    "admin|sk-admin-123456",
    "user1|sk-user1-789012"
  ],
  
  "supported_models": [
    ".*glm.*",
    ".*gpt.*",
    ".*claude.*"
  ],
  
  "max_connections": 100,
  "max_keepalive_connections": 20,
  "keepalive_expiry": 30.0,
  "stream_timeout": 300.0,
  "non_stream_timeout": 30.0,
  "max_response_size": 10485760
}
```

### é…ç½®è¯´æ˜

#### æ—¥å¿—çº§åˆ« (log_level)

| çº§åˆ« | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `DEBUG` | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | å¼€å‘ç¯å¢ƒ |
| `INFO` | ä¸€èˆ¬ä¿¡æ¯ | æµ‹è¯•ç¯å¢ƒ |
| `WARNING` | è­¦å‘Šï¼ˆé»˜è®¤ï¼‰ | ç”Ÿäº§ç¯å¢ƒ |
| `ERROR` | é”™è¯¯ | é«˜æ€§èƒ½ç”Ÿäº§ç¯å¢ƒ |
| `CRITICAL` | ä¸¥é‡é”™è¯¯ | ä»…è®°å½•ä¸¥é‡é—®é¢˜ |

#### è¿æ¥æ± é…ç½®

- `max_connections`: æœ€å¤§è¿æ¥æ•°ï¼Œæ§åˆ¶å¹¶å‘è¯·æ±‚ä¸Šé™
- `max_keepalive_connections`: ä¿æŒæ´»è·ƒçš„è¿æ¥æ•°ï¼Œæé«˜å¤ç”¨æ•ˆç‡
- `keepalive_expiry`: è¿æ¥ä¿æŒæ—¶é—´ï¼Œè¶…æ—¶åè‡ªåŠ¨å…³é—­

#### è¶…æ—¶é…ç½®

- `stream_timeout`: æµå¼è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œå»ºè®®300ç§’ä»¥ä¸Š
- `non_stream_timeout`: éæµå¼è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé€šå¸¸30ç§’è¶³å¤Ÿ

#### å“åº”å¤§å°é™åˆ¶

- `max_response_size`: æœ€å¤§å“åº”å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œé˜²æ­¢å†…å­˜è€—å°½
  - é»˜è®¤10MB (10485760å­—èŠ‚)
  - å¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´

## ğŸ”Œ APIç«¯ç‚¹

### åŸºç¡€ç«¯ç‚¹

- `GET /` - æœåŠ¡ä¿¡æ¯å’Œå¯ç”¨ç«¯ç‚¹
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /v1/reload` - é‡æ–°åŠ è½½é…ç½®ï¼ˆçƒ­é‡è½½ï¼‰

### OpenAIå…¼å®¹ç«¯ç‚¹

- `GET /v1/models` - è·å–æ‰€æœ‰å¯ç”¨æ¨¡å‹
- `POST /v1/chat/completions` - èŠå¤©è¡¥å…¨ï¼ˆæ”¯æŒæµå¼ï¼‰

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### 1. å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8001/health
```

å“åº”ï¼š
```json
{
  "status": "healthy",
  "providers": {
    "zhipu": true,
    "openai": true
  },
  "healthy_providers": 2,
  "total_providers": 2
}
```

### 2. è·å–æ¨¡å‹åˆ—è¡¨

```bash
curl http://localhost:8001/v1/models
```

å“åº”ï¼š
```json
{
  "object": "list",
  "data": [
    {
      "id": "zhipu/glm-4",
      "object": "model",
      "owned_by": "zhipu"
    },
    {
      "id": "openai/gpt-4",
      "object": "model",
      "owned_by": "openai"
    }
  ]
}
```

### 3. éæµå¼èŠå¤©è¡¥å…¨

```bash
curl -X POST http://localhost:8001/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-test-123456" \
  -d '{
    "model": "zhipu/glm-4",
    "messages": [
      {"role": "user", "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±"}
    ],
    "temperature": 0.7,
    "max_tokens": 100
  }'
```

### 4. æµå¼èŠå¤©è¡¥å…¨

```bash
curl -X POST http://localhost:8001/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-test-123456" \
  -d '{
    "model": "zhipu/glm-4",
    "messages": [
      {"role": "user", "content": "å†™ä¸€é¦–è¯—"}
    ],
    "stream": true
  }'
```

### 5. çƒ­é‡è½½é…ç½®

```bash
curl -X POST http://localhost:8001/v1/reload
```

å“åº”ï¼š
```json
{
  "message": "é…ç½®é‡æ–°åŠ è½½æˆåŠŸ",
  "providers_count": 2
}
```

## ğŸ”’ TokenéªŒè¯

æ‰€æœ‰ `/v1/chat/completions` è¯·æ±‚éƒ½éœ€è¦æä¾›æœ‰æ•ˆçš„Bearer Tokenã€‚

### ä½¿ç”¨Token

```bash
curl -X POST http://localhost:8001/v1/chat/completions \
  -H "Authorization: Bearer sk-test-123456" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### æ— Tokenè®¿é—®

å¦‚æœæœªæä¾›Tokenæˆ–Tokenæ— æ•ˆï¼Œå°†è¿”å›401é”™è¯¯ï¼š
```json
{
  "error": {
    "message": "æœªæä¾›API token",
    "type": "http_error",
    "code": 401
  }
}
```

## ğŸ¯ é«˜çº§ç‰¹æ€§

### 1. æµå¼å“åº”ä¼˜åŒ–

- âœ… ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ç¡®ä¿è¿æ¥å…³é—­
- âœ… å¤„ç†å®¢æˆ·ç«¯æ–­å¼€ï¼ˆCancelledErrorï¼‰
- âœ… è¶…æ—¶ä¼˜åŒ–ï¼ˆæµå¼300ç§’ï¼Œéæµå¼30ç§’ï¼‰
- âœ… æ•°æ®å—è®¡æ•°ç›‘æ§

### 2. éæµå¼å“åº”ä¼˜åŒ–

- âœ… åŒºåˆ†æµå¼/éæµå¼è¯·æ±‚æ–¹å¼
- âœ… å“åº”å¤§å°é™åˆ¶ï¼ˆ10MBï¼‰
- âœ… æ€§èƒ½ç›‘æ§ï¼ˆè€—æ—¶+å¤§å°ï¼‰
- âœ… ä¼˜åŒ–çš„è¯»å–æ–¹å¼

### 3. è¿æ¥æ± ç®¡ç†

- âœ… æœ€å¤§è¿æ¥æ•°ï¼š100
- âœ… ä¿æŒè¿æ¥æ•°ï¼š20
- âœ… è¿æ¥è¿‡æœŸæ—¶é—´ï¼š30ç§’

### 4. å¥åº·æ£€æŸ¥

- âœ… å¹¶å‘æ£€æŸ¥æ‰€æœ‰ä¾›åº”å•†
- âœ… è¿”å›è¯¦ç»†çš„å¥åº·çŠ¶æ€
- âœ… æ”¯æŒå®šæœŸç›‘æ§

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

æ‰€æœ‰æ€§èƒ½å‚æ•°å‡å¯é€šè¿‡ `config.json` é…ç½®ï¼š

| ç‰¹æ€§ | é»˜è®¤å€¼ | é…ç½®é¡¹ | è¯´æ˜ |
|------|--------|--------|------|
| æµå¼è¶…æ—¶ | 300ç§’ | `stream_timeout` | æµå¼è¯·æ±‚çš„æœ€å¤§ç­‰å¾…æ—¶é—´ |
| éæµå¼è¶…æ—¶ | 30ç§’ | `non_stream_timeout` | éæµå¼è¯·æ±‚çš„æœ€å¤§ç­‰å¾…æ—¶é—´ |
| æœ€å¤§å“åº”å¤§å° | 10MB | `max_response_size` | å•ä¸ªå“åº”çš„æœ€å¤§å­—èŠ‚æ•° |
| æœ€å¤§è¿æ¥æ•° | 100 | `max_connections` | è¿æ¥æ± çš„æœ€å¤§è¿æ¥æ•° |
| ä¿æŒè¿æ¥æ•° | 20 | `max_keepalive_connections` | ä¿æŒæ´»è·ƒçš„è¿æ¥æ•° |
| è¿æ¥è¿‡æœŸæ—¶é—´ | 30ç§’ | `keepalive_expiry` | ç©ºé—²è¿æ¥çš„è¿‡æœŸæ—¶é—´ |
| å¹¶å‘å¥åº·æ£€æŸ¥ | æ˜¯ |

## ğŸ› ï¸ è¿ç»´ç®¡ç†

### æ—¥å¿—ç®¡ç†

æ—¥å¿—æ–‡ä»¶ï¼š`ai_proxy.log`

æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š
```bash
tail -f ai_proxy.log
```

æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š
```bash
grep ERROR ai_proxy.log
```

æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡ï¼š
```bash
grep "è€—æ—¶:" ai_proxy.log | awk '{print $(NF-1)}' | sort -n
```

### é…ç½®çƒ­é‡è½½

ä¿®æ”¹ `config.json` åï¼Œæ— éœ€é‡å¯æœåŠ¡ï¼š
```bash
curl -X POST http://localhost:8001/v1/reload
```

æ”¯æŒçƒ­é‡è½½çš„é…ç½®é¡¹ï¼š
- âœ… ä¾›åº”å•†åˆ—è¡¨
- âœ… Tokenç™½åå•
- âœ… æ”¯æŒçš„æ¨¡å‹
- âœ… æ—¥å¿—çº§åˆ«

### ç›‘æ§æŒ‡æ ‡

ç¨‹åºä¼šè®°å½•ä»¥ä¸‹ç›‘æ§ä¿¡æ¯ï¼š
- è¯·æ±‚è€—æ—¶
- å“åº”å¤§å°
- è¿æ¥çŠ¶æ€
- å¥åº·æ£€æŸ¥ç»“æœ
- é”™è¯¯ç»Ÿè®¡

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**: è¯·æ±‚è¶…æ—¶æˆ–è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ä¾›åº”å•†APIæ˜¯å¦å¯è®¿é—®
2. éªŒè¯API Keyæ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
4. ä½¿ç”¨ `/health` ç«¯ç‚¹æ£€æŸ¥ä¾›åº”å•†çŠ¶æ€

### é—®é¢˜2: TokenéªŒè¯å¤±è´¥

**ç—‡çŠ¶**: è¿”å›401é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤Tokenåœ¨ `config.json` çš„ `tokens` åˆ—è¡¨ä¸­
2. æ£€æŸ¥Tokenæ ¼å¼æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤è¯·æ±‚å¤´ä¸­åŒ…å« `Authorization: Bearer <token>`

### é—®é¢˜3: æ¨¡å‹ä¸å¯ç”¨

**ç—‡çŠ¶**: è¿”å›"æœªæ‰¾åˆ°æ¨¡å‹"é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. ä½¿ç”¨ `/v1/models` æŸ¥çœ‹å¯ç”¨æ¨¡å‹åˆ—è¡¨
2. ç¡®è®¤æ¨¡å‹åç§°æ ¼å¼ï¼š`ä¾›åº”å•†/æ¨¡å‹`
3. æ£€æŸ¥ `supported_models` é…ç½®

### é—®é¢˜4: æ—¥å¿—è¿‡å¤š

**ç—‡çŠ¶**: æ—¥å¿—æ–‡ä»¶è¿‡å¤§

**è§£å†³æ–¹æ³•**:
1. è°ƒæ•´æ—¥å¿—çº§åˆ«ä¸º `WARNING` æˆ– `ERROR`
2. é…ç½®æ—¥å¿—è½®è½¬ï¼ˆlogrotateï¼‰
3. å®šæœŸæ¸…ç†æ—§æ—¥å¿—

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–è¯´æ˜

### æµå¼ä¼ è¾“ä¼˜åŒ–

1. **ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**
   - ç”Ÿæˆå™¨å†…éƒ¨çš„ try-except-finally
   - APIå±‚çš„å¼‚å¸¸å¤„ç†
   - æœ€ç»ˆçš„ finally æ¸…ç†å—

2. **èµ„æºç®¡ç†**
   - æ‰€æœ‰è¿æ¥ç¡®ä¿å…³é—­
   - å¤„ç†å®¢æˆ·ç«¯æ–­å¼€ï¼ˆCancelledErrorï¼‰
   - æ•°æ®å—è®¡æ•°ç›‘æ§

3. **è¶…æ—¶ä¼˜åŒ–**
   - æµå¼è¯·æ±‚æ”¯æŒé•¿æ—¶é—´å“åº”ï¼ˆé»˜è®¤300ç§’ï¼‰
   - å¯æ ¹æ®æ¨¡å‹ç‰¹æ€§è°ƒæ•´

### éæµå¼ä¼ è¾“ä¼˜åŒ–

1. **è¯·æ±‚æ–¹å¼ä¼˜åŒ–**
   - æµå¼è¯·æ±‚ä½¿ç”¨ stream=True
   - éæµå¼è¯·æ±‚ç›´æ¥POSTï¼ˆæ›´é«˜æ•ˆï¼‰

2. **å“åº”å¤§å°ä¿æŠ¤**
   - æ£€æŸ¥ Content-Length å¤´
   - éªŒè¯å®é™…è¯»å–å¤§å°
   - åŒé‡ä¿æŠ¤æœºåˆ¶

3. **æ€§èƒ½ç›‘æ§**
   - è®°å½•è¯·æ±‚è€—æ—¶
   - è®°å½•å“åº”å¤§å°
   - ä¾¿äºæ€§èƒ½åˆ†æ

### è¿æ¥æ± ç®¡ç†

1. **è¿æ¥å¤ç”¨**
   - ä¿æŒæ´»è·ƒè¿æ¥å‡å°‘æ¡æ‰‹å¼€é”€
   - è‡ªåŠ¨æ¸…ç†è¿‡æœŸè¿æ¥

2. **å¹¶å‘æ§åˆ¶**
   - é™åˆ¶æœ€å¤§è¿æ¥æ•°é˜²æ­¢èµ„æºè€—å°½
   - æ”¯æŒé«˜å¹¶å‘åœºæ™¯

### è°ƒä¼˜å»ºè®®

#### é«˜å¹¶å‘åœºæ™¯
```json
{
  "max_connections": 200,
  "max_keepalive_connections": 50,
  "stream_timeout": 600.0
}
```

#### ä½å»¶è¿Ÿåœºæ™¯
```json
{
  "max_connections": 50,
  "max_keepalive_connections": 10,
  "non_stream_timeout": 10.0
}
```

#### å¤§æ¨¡å‹åœºæ™¯
```json
{
  "stream_timeout": 600.0,
  "max_response_size": 52428800
}
```

## ğŸ”§ å¼€å‘

### é¡¹ç›®ç»“æ„

```
AI-Proxy/
â”œâ”€â”€ api.py                          # FastAPIåº”ç”¨ä¸»æ–‡ä»¶
â”œâ”€â”€ client.py                       # ä¾›åº”å•†å®¢æˆ·ç«¯å’Œæ¨¡å‹ç®¡ç†å™¨
â”œâ”€â”€ config.py                       # é…ç½®ç®¡ç†æ¨¡å—
â”œâ”€â”€ config.json                     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ config.json.example             # é…ç½®ç¤ºä¾‹
â”œâ”€â”€ requirements.txt                # Pythonä¾èµ–
â”œâ”€â”€ ai_proxy.log                    # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ README.md                       # æœ¬æ–‡ä»¶
â”œâ”€â”€ STREAM_ANALYSIS_REPORT.md       # æµå¼ä¼ è¾“åˆ†æ
â”œâ”€â”€ IMPROVEMENTS.md                 # æ”¹è¿›æ¸…å•
â”œâ”€â”€ NON_STREAM_IMPROVEMENTS.md      # éæµå¼æ”¹è¿›
â””â”€â”€ LOG_LEVEL_CONFIG.md             # æ—¥å¿—é…ç½®è¯´æ˜
```

### ä¾èµ–é¡¹

- `fastapi` - Webæ¡†æ¶
- `uvicorn` - ASGIæœåŠ¡å™¨
- `httpx` - å¼‚æ­¥HTTPå®¢æˆ·ç«¯
- `pydantic` - æ•°æ®éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio

# è¿è¡Œæµ‹è¯•
pytest
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueã€‚

---

**ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2025-11-21  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
